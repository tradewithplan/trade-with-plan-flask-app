<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Trade with Plan</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e2e8f0;
        }
        .gradient-text {
            background: linear-gradient(90deg, #a78bfa, #6b21a8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: inherit;
            font-weight: inherit;
        }
        /* Style for sortable table headers */
        th a {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* space between text and arrow */
        }
    </style>
</head>
<body class="antialiased">

    <!-- Flash Messages Container -->
    <div id="flash-messages-container" class="fixed top-5 left-5 z-50 w-full max-w-md">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flex justify-between items-center p-4 mb-4 text-sm rounded-lg shadow-lg
                    {% if category == 'success' %} bg-green-600 text-white
                    {% elif category == 'error' %} bg-red-900 text-red-300
                    {% elif category == 'warning' %} bg-yellow-900 text-yellow-300
                    {% else %} bg-blue-900 text-blue-300 {% endif %}"
                    role="alert">
                    <span>{{ message }}</span>
                    <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-current rounded-lg focus:ring-2 focus:ring-gray-400 p-1.5 hover:bg-gray-800/50 inline-flex h-8 w-8" data-dismiss-target>
                        <span class="sr-only">Dismiss</span>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container mx-auto px-6 py-12">
        <header class="mb-10 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white leading-tight mb-2">
                {% if session.get('role') == 'admin' %}
                    <span class="gradient-text">Admin</span> Dashboard
                {% else %}
                    <span class="gradient-text">Supervisor</span> Dashboard
                {% endif %}
            </h1>
            <p class="text-gray-400">View and manage users and purchases.</p>
            <a href="{{ url_for('logout') }}" class="mt-4 inline-block bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Logout</a>
        </header>

        <main class="space-y-12">
            <!-- Manage Users Section -->
            <section class="bg-gray-900 rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold text-white mb-6">Manage Users</h2>
                <form method="get" action="{{ url_for('admin_dashboard') }}" class="mb-6">
                    <div class="flex">
                        <input type="text" name="user_filter" placeholder="Filter by name or email..." value="{{ user_filter or '' }}"
                               class="flex-grow p-2 rounded-l-md bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-r-md transition-colors">Filter</button>
                    </div>
                </form>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800">
                            <tr>
                                <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">
                                    {% set next_order = 'desc' if sort_by == 'id' and order == 'asc' else 'asc' %}
                                    <a href="{{ url_for('admin_dashboard', sort_by='id', order=next_order, user_filter=user_filter) }}">
                                        ID {% if sort_by == 'id' %}<span class="ml-1">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
                                    </a>
                                </th>
                                <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">
                                    {% set next_order = 'desc' if sort_by == 'fullname' and order == 'asc' else 'asc' %}
                                    <a href="{{ url_for('admin_dashboard', sort_by='fullname', order=next_order, user_filter=user_filter) }}">
                                        Full Name {% if sort_by == 'fullname' %}<span class="ml-1">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
                                    </a>
                                </th>
                                <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">
                                    {% set next_order = 'desc' if sort_by == 'email' and order == 'asc' else 'asc' %}
                                    <a href="{{ url_for('admin_dashboard', sort_by='email', order=next_order, user_filter=user_filter) }}">
                                        Email {% if sort_by == 'email' %}<span class="ml-1">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
                                    </a>
                                </th>
                                {% if session.get('role') == 'admin' %}
                                    <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">
                            {% for user in users %}
                                <tr>
                                    <td class="py-4 px-4 text-sm font-medium text-gray-300">{{ user.id }}</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ user.fullname }}</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ user.email }}</td>
                                    {% if session.get('role') == 'admin' %}
                                    <td class="py-4 px-4 text-sm whitespace-nowrap space-x-4">
                                        <a href="{{ url_for('edit_user', user_id=user.id) }}" class="text-blue-400 hover:text-blue-600 transition-colors">Edit</a>
                                        <form action="{{ url_for('delete_user', user_id=user.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this user and all their purchases?');" class="inline">
                                            <button type="submit" class="text-red-500 hover:text-red-700 transition-colors">Delete</button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                            {% else %}
                                <tr><td colspan="4" class="py-4 px-4 text-sm text-center text-gray-500">No users found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Manage Purchases Section -->
            <section class="bg-gray-900 rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold text-white mb-6">Manage Purchases</h2>

                {% if session.get('role') == 'admin' %}
                <div class="mb-8 p-4 bg-gray-800 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Add New Purchase</h3>
                    <form action="{{ url_for('add_purchase') }}" method="post" class="space-y-4">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="email" name="user_email" placeholder="User Email" required
                                   class="flex-1 p-2 rounded-md bg-gray-900 border border-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <select name="course_name" required
                                    class="flex-1 p-2 rounded-md bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="" disabled selected>Select a Course</option>
                                <option value='ICT "Forever Model"'>ICT "Forever Model"</option>
                                <option value="Basic to Advanced">Basic to Advanced</option>
                                <option value="1-1 Personal Mentorship">1-1 Personal Mentorship</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 rounded-lg transition-colors">Add Purchase</button>
                    </form>
                </div>
                {% endif %}
                
                <form method="get" action="{{ url_for('admin_dashboard') }}" class="mb-6">
                    <div class="flex">
                        <input type="text" name="purchase_filter" placeholder="Filter by user, email, or course..." value="{{ purchase_filter or '' }}"
                               class="flex-grow p-2 rounded-l-md bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-r-md transition-colors">Filter</button>
                    </div>
                </form>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800">
                            <tr>
                                <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">
                                    {% set next_order = 'desc' if sort_by == 'id' and order == 'asc' else 'asc' %}
                                    <a href="{{ url_for('admin_dashboard', sort_by='id', order=next_order, purchase_filter=purchase_filter) }}">
                                        ID {% if sort_by == 'id' %}<span class="ml-1">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
                                    </a>
                                </th>
                                <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">
                                     {% set next_order = 'desc' if sort_by == 'fullname' and order == 'asc' else 'asc' %}
                                    <a href="{{ url_for('admin_dashboard', sort_by='fullname', order=next_order, purchase_filter=purchase_filter) }}">
                                        User {% if sort_by == 'fullname' %}<span class="ml-1">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
                                    </a>
                                </th>
                                <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">
                                     {% set next_order = 'desc' if sort_by == 'course_name' and order == 'asc' else 'asc' %}
                                    <a href="{{ url_for('admin_dashboard', sort_by='course_name', order=next_order, purchase_filter=purchase_filter) }}">
                                        Course {% if sort_by == 'course_name' %}<span class="ml-1">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
                                    </a>
                                </th>
                                <th scope="col" class="py-3.5 px-4 text-sm font-semibold text-gray-400 text-left">
                                     {% set next_order = 'desc' if sort_by == 'purchase_date' and order == 'asc' else 'asc' %}
                                    <a href="{{ url_for('admin_dashboard', sort_by='purchase_date', order=next_order, purchase_filter=purchase_filter) }}">
                                        Purchase Date {% if sort_by == 'purchase_date' %}<span class="ml-1">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
                                    </a>
                                </th>
                                {% if session.get('role') == 'admin' %}
                                <th scope="col" class="relative py-3.5 px-4"><span class="sr-only">Actions</span></th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">
                            {% for purchase in purchases %}
                                <tr>
                                    <td class="py-4 px-4 text-sm font-medium text-gray-300">{{ purchase.id }}</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ purchase.fullname }} ({{ purchase.email }})</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ purchase.course_name }}</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ purchase.purchase_date | format_ist }}</td>
                                    {% if session.get('role') == 'admin' %}
                                    <td class="py-4 px-4 text-sm whitespace-nowrap">
                                        <form action="{{ url_for('delete_purchase', purchase_id=purchase.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this purchase?');">
                                            <button type="submit" class="text-red-500 hover:text-red-700 transition-colors">Revoke</button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                            {% else %}
                                <tr><td colspan="5" class="py-4 px-4 text-sm text-center text-gray-500">No purchases found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // Script for dismissing flash messages
        function dismissMessage(element) {
            if (!element) return;
            element.style.transition = 'opacity 0.5s ease-out';
            element.style.opacity = '0';
            setTimeout(() => {
                element.remove();
            }, 500);
        }

        const flashMessages = document.querySelectorAll('.flash-message');

        flashMessages.forEach(message => {
            const closeButton = message.querySelector('[data-dismiss-target]');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    dismissMessage(message);
                });
            }
            setTimeout(() => {
                dismissMessage(message);
            }, 4000);
        });
    </script>
</body>
</html>